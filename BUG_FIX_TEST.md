# 🐛 Bug 修复测试指南

## 🎯 修复的问题

### 1. 功能窗口立即关闭问题 ✅
**原因**：点击选项后，文本选择变为空，触发了 `hideAllInterfaces()`
**修复**：
- 修改了 `handleTextSelection` 函数，空选择时只隐藏 mini icon 和选项栏
- 修改了 `handleDocumentClick` 函数，增加了对功能窗口的保护
- 在 `shouldExcludeSelection` 中排除功能窗口内的文本选择

### 2. 莫名出现自定义选项问题 ✅
**原因**：设置代码中有残留的自定义选项逻辑
**修复**：
- 在 `loadSettings` 和 `saveSettings` 中清理自定义选项数据
- 添加了 `cleanupStorageData` 函数自动清理错误数据
- 过滤选项顺序，只保留默认的三个选项

### 3. 增强的用户体验 ✅
**新增功能**：
- 添加了关闭按钮（×）在功能窗口右上角
- 支持 ESC 键关闭功能窗口
- 改进了点击外部区域的关闭逻辑

## 🧪 测试步骤

### 测试1：功能窗口不再立即关闭
1. **重新加载扩展**
2. **选中文本** → 点击 mini icon → 点击任意选项
3. **预期结果**：功能窗口应该保持打开状态，不会立即消失
4. **验证**：可以看到加载状态，等待 AI 响应

### 测试2：自定义选项清理
1. **打开设置面板** → 划词助手标签页
2. **检查选项顺序列表**：应该只有"解读"、"翻译"、"对话"三个选项
3. **如果还有 custom_xxx 选项**：
   - 重新加载扩展
   - 再次检查设置面板
   - 应该自动清理掉

### 测试3：拖拽功能
1. **在设置面板中拖拽选项**
2. **预期结果**：
   - 光标变为抓手样式
   - 拖拽时有视觉反馈
   - 可以多次拖拽
   - 顺序正确保存

### 测试4：关闭功能
1. **打开功能窗口后**，测试以下关闭方式：
   - 点击右上角的 × 按钮
   - 按 ESC 键
   - 点击窗口外部区域
2. **预期结果**：窗口正确关闭

### 测试5：文本选择不干扰功能窗口
1. **打开功能窗口**
2. **在页面其他地方选择文本**
3. **预期结果**：功能窗口不会被关闭

## 📋 验证清单

- [ ] 功能窗口不再立即关闭
- [ ] 可以正常等待和显示 AI 响应
- [ ] 设置面板中没有 custom_xxx 选项
- [ ] 拖拽功能正常工作，光标样式正确
- [ ] 关闭按钮（×）可以关闭窗口
- [ ] ESC 键可以关闭窗口
- [ ] 点击外部可以关闭窗口
- [ ] 在功能窗口内选择文本不会关闭窗口
- [ ] 在页面其他地方选择文本不会关闭功能窗口

## 🔍 调试信息

### 正常的控制台日志应该是：
```
[TextSelectionHelper] Text selection detected: "选中的文本..."
[TextSelectionHelper] Showing mini icon for selection
[TextSelectionHelper] Option clicked: interpret
[TextSelectionHelper] Showing function window for: interpret
// 不应该再有 "Text selection detected: empty" 导致窗口关闭
```

### 如果还有问题：
1. **检查控制台错误**
2. **确认 API Key 已配置**
3. **重新加载扩展**
4. **清除浏览器缓存**

## 💰 测试成功标准

如果以上所有测试都通过，说明修复成功！特别是：
1. ✅ 功能窗口不再立即关闭
2. ✅ 没有莫名的自定义选项
3. ✅ 拖拽功能完全正常
4. ✅ 用户体验流畅

---

**注意**：如果测试过程中发现任何问题，请提供详细的错误信息和复现步骤。
